const express = require('express');
const cors = require('cors');
const app = express();
app.use(cors());

app.use(express.json());

var memory = new Array(30).fill('_');
var users = [
    {
        'username':'bob',
        'password':'secret123',
        'session' : '80ac1101c9228c423bc9783' 
    },
    {
        'username':'gary',
        'password':'password',
        'session' : '54eb5afcc868a5e2699ca4' 
    }
]

var sessions = ['bob:80ac1101c9228c423bc9783','gary:54eb5afcc868a5e2699ca4']
sensitive_data = sessions.join('')

for(let i=0;i<sensitive_data.length;i++){
    memory[30+i] = sensitive_data[i];
}

function vuln_function(inp,buffer){
    var len = inp.length;
    if(len>0){
        len=30;
    }
    for(let i=0;i<len;i++){
        buffer[i] = inp[i]
    }
    return inp.length; 
}

app.get('/username', (req,res) => {
    const token = req.headers.session_id;
    const user = users.find((item) => item.session === token);
    if(user){
        res.status(200).send({
            "username": user.username
        })
    }
    else{
        res.sendStatus(401)
    }
})

app.post('/doAuthentication', (req,res) => {
    const token = req.headers.host;
    const body = req.body;
    var len = vuln_function(token,memory);
    const user = users.find((item) => item.username === body.username)
    
    if(user && (body.password === user.password)){
        res.status(200).send({
            "state" : 1,
            "session_id" : user.session,
            "message" : "Successful Login"
        });
    }
    else{
        res.send(
            {
                "state" : 0,
                "message": `Auth failed for host: ${memory.slice(0,len).join('')}`
            }
        );
    }
})

app.listen(3000,'0.0.0.0');